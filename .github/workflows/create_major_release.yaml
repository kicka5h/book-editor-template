name: Create Release on Major Version

on:
  push:
    branches:
      - main
    paths:
      - 'Chapters/**/v*.0.0/*.md'

jobs:
  detect-major-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to compare
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Detect major version changes
        id: detect
        run: |
          python3 <<'EOF'
          import os
          import re
          import subprocess
          from pathlib import Path
          
          # Get changed files in the last commit
          result = subprocess.run(
              ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
              capture_output=True,
              text=True
          )
          
          changed_files = result.stdout.strip().split('\n')
          major_versions = []
          
          # Pattern to match major version directories (vX.0.0)
          major_version_pattern = re.compile(r'v(\d+)\.0\.0')
          
          for file in changed_files:
              if file.startswith('Chapters/') and file.endswith('.md'):
                  parts = Path(file).parts
                  # Check if this is a version directory
                  for part in parts:
                      match = major_version_pattern.match(part)
                      if match:
                          major_num = match.group(1)
                          # Extract chapter number
                          chapter_match = re.search(r'[Cc]hapter\s+(\d+)', file)
                          if chapter_match:
                              chapter_num = chapter_match.group(1)
                              major_versions.append({
                                  'chapter': chapter_num,
                                  'version': part,
                                  'major': major_num,
                                  'file': file
                              })
                              print(f"Detected major version: Chapter {chapter_num} - {part}")
          
          if major_versions:
              # Set output for GitHub Actions
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"has_major_version=true\n")
                  # Create release notes
                  chapters_list = ', '.join([f"Chapter {v['chapter']}" for v in major_versions])
                  f.write(f"chapters={chapters_list}\n")
                  
                  # Use the highest chapter number and version for tag
                  latest = max(major_versions, key=lambda x: (int(x['chapter']), int(x['major'])))
                  tag = f"chapter-{latest['chapter']}-{latest['version']}"
                  f.write(f"release_tag={tag}\n")
                  f.write(f"release_name=Chapter {latest['chapter']} - Major Release {latest['version']}\n")
                  
                  # Store all changes for release notes
                  release_body = "## Major Version Updates\n\n"
                  for v in sorted(major_versions, key=lambda x: int(x['chapter'])):
                      release_body += f"- **Chapter {v['chapter']}**: {v['version']}\n"
                  
                  # Escape for GitHub Actions
                  release_body = release_body.replace('%', '%25').replace('\n', '%0A').replace('\r', '%0D')
                  f.write(f"release_body={release_body}\n")
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"has_major_version=false\n")
              print("No major version changes detected")
          EOF
      
      - name: Install Pandoc
        if: steps.detect.outputs.has_major_version == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-latex-extra texlive-fonts-recommended
      
      - name: Generate release PDF
        if: steps.detect.outputs.has_major_version == 'true'
        run: |
          python3 <<'EOF'
          import re
          from pathlib import Path
          
          def parse_version(version_str):
              match = re.match(r'v?(\d+)\.(\d+)\.(\d+)', version_str)
              if not match:
                  return None
              return tuple(map(int, match.groups()))
          
          chapters_dir = Path('Chapters')
          latest_chapters = []
          
          chapter_dirs = sorted(
              [d for d in chapters_dir.iterdir() if d.is_dir() and d.name.lower().startswith('chapter')],
              key=lambda x: int(re.search(r'\d+', x.name).group())
          )
          
          for chapter_dir in chapter_dirs:
              version_dirs = []
              for version_dir in chapter_dir.iterdir():
                  if version_dir.is_dir() and version_dir.name.startswith('v'):
                      version = parse_version(version_dir.name)
                      if version:
                          version_dirs.append((version, version_dir))
              
              if version_dirs:
                  version_dirs.sort(key=lambda x: x[0], reverse=True)
                  latest_version_dir = version_dirs[0][1]
                  md_files = list(latest_version_dir.glob('*.md'))
                  if md_files:
                      latest_chapters.append(md_files[0])
          
          with open('chapters_to_combine.txt', 'w') as f:
              for chapter in latest_chapters:
                  f.write(f"{chapter}\n")
          EOF
          
          # Generate PDF
          mapfile -t chapters < chapters_to_combine.txt
          DATE=$(date +%Y-%m-%d)
          OUTPUT_FILE="In_the_Presence_of_Power_Most_Foul_${DATE}.pdf"
          
          pandoc "${chapters[@]}" \
            -o "$OUTPUT_FILE" \
            --pdf-engine=pdflatex \
            -V geometry:margin=1in \
            -V fontsize=12pt \
            -V documentclass=book \
            -V papersize=letter \
            --toc \
            --toc-depth=2 \
            -V title="In the Presence of Power Most Foul" \
            -V author="Ash" \
            -V date="$DATE" \
            --highlight-style=tango \
            --number-sections
          
          echo "pdf_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
        id: generate_pdf
      
      - name: Create GitHub Release
        if: steps.detect.outputs.has_major_version == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.detect.outputs.release_tag }}
          name: ${{ steps.detect.outputs.release_name }}
          body: ${{ steps.detect.outputs.release_body }}
          files: |
            *.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        if: steps.detect.outputs.has_major_version == 'true'
        run: |
          echo "### ðŸŽ‰ Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.detect.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chapters:** ${{ steps.detect.outputs.chapters }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release has been published with the compiled book PDF!" >> $GITHUB_STEP_SUMMARY